
"""
Comando /clown - Owner only
Permite activar/desactivar reacciones autom√°ticas con emoji clown en un canal
"""
import discord
from discord.ext import commands
import logging
import json
from datetime import datetime
from pathlib import Path

logger = logging.getLogger(__name__)

# Sistema de gesti√≥n de canales con reacciones autom√°ticas
class ClownReactionManager:
    def __init__(self):
        self.config_file = "clown_reactions_config.json"
        self.active_channels = set()
        self.load_config()

    def load_config(self):
        """Cargar configuraci√≥n de canales activos"""
        try:
            if Path(self.config_file).exists():
                with open(self.config_file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    self.active_channels = set(data.get('active_channels', []))
                logger.info(f"‚úÖ Configuraci√≥n de reacciones clown cargada: {len(self.active_channels)} canales activos")
            else:
                self.active_channels = set()
                logger.info("üìÅ Archivo de configuraci√≥n de reacciones clown creado")
        except Exception as e:
            logger.error(f"‚ùå Error cargando configuraci√≥n de reacciones clown: {e}")
            self.active_channels = set()

    def save_config(self):
        """Guardar configuraci√≥n de canales activos"""
        try:
            data = {
                'active_channels': list(self.active_channels),
                'last_updated': datetime.now().isoformat(),
                'total_active_channels': len(self.active_channels)
            }
            with open(self.config_file, 'w', encoding='utf-8') as f:
                json.dump(data, f, indent=2, ensure_ascii=False)
            logger.info("üíæ Configuraci√≥n de reacciones clown guardada exitosamente")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error guardando configuraci√≥n de reacciones clown: {e}")
            return False

    def activate_channel(self, channel_id: str) -> bool:
        """Activar reacciones autom√°ticas en un canal"""
        self.active_channels.add(channel_id)
        return self.save_config()

    def deactivate_channel(self, channel_id: str) -> bool:
        """Desactivar reacciones autom√°ticas en un canal"""
        self.active_channels.discard(channel_id)
        return self.save_config()

    def is_channel_active(self, channel_id: str) -> bool:
        """Verificar si un canal tiene reacciones autom√°ticas activas"""
        return channel_id in self.active_channels

    def get_active_channels_count(self) -> int:
        """Obtener n√∫mero de canales activos"""
        return len(self.active_channels)

# Instancia global del gestor
clown_manager = ClownReactionManager()

def setup_commands(bot):
    """Configurar comando /clown y evento de reacciones autom√°ticas"""

    @bot.tree.command(name="clown", description="[OWNER ONLY] Activar/desactivar reacciones autom√°ticas con emoji clown en este canal")
    async def clown_command(interaction: discord.Interaction, accion: str = "toggle"):
        """
        Comando para gestionar reacciones autom√°ticas con emoji clown

        Args:
            accion: 'on' para activar, 'off' para desactivar, 'toggle' para alternar, 'status' para ver estado
        """
        user_id = str(interaction.user.id)
        username = f"{interaction.user.name}#{interaction.user.discriminator}"
        channel_id = str(interaction.channel.id)

        # Verificar que solo el owner pueda usar este comando
        from main import DISCORD_OWNER_ID, delegated_owners
        if user_id != DISCORD_OWNER_ID and user_id not in delegated_owners:
            embed = discord.Embed(
                title="‚ùå Acceso Denegado",
                description="Este comando solo puede ser usado por el owner del bot o usuarios con acceso delegado.",
                color=0xff0000
            )
            await interaction.response.send_message(embed=embed, ephemeral=True)
            return

        await interaction.response.defer(ephemeral=True)

        try:
            # Verificar que el bot tenga permisos para reaccionar
            permissions = interaction.channel.permissions_for(interaction.guild.me)
            if not permissions.add_reactions or not permissions.read_message_history:
                embed = discord.Embed(
                    title="<:1000182563:1396420770904932372> Permisos Insuficientes",
                    description="El bot necesita permisos de **A√±adir Reacciones** y **Leer Historial de Mensajes** en este canal.",
                    color=0xff0000
                )
                embed.add_field(
                    name="<:1000182751:1396420551798558781> Permisos Requeridos:",
                    value="‚Ä¢ A√±adir Reacciones\n‚Ä¢ Leer Historial de Mensajes\n‚Ä¢ Ver Canal",
                    inline=False
                )
                await interaction.followup.send(embed=embed, ephemeral=True)
                return

            current_status = clown_manager.is_channel_active(channel_id)
            
            # Procesar acci√≥n
            if accion.lower() == "on":
                if current_status:
                    embed = discord.Embed(
                        title="<a:clown:1418508263984463932> Ya Activado",
                        description="Las reacciones autom√°ticas con emoji clown ya est√°n **activadas** en este canal.",
                        color=0xffaa00
                    )
                else:
                    success = clown_manager.activate_channel(channel_id)
                    if success:
                        embed = discord.Embed(
                            title="<a:clown:1418508263984463932> Reacciones Activadas",
                            description="¬°Las reacciones autom√°ticas con emoji clown han sido **activadas** en este canal!",
                            color=0x00ff88
                        )
                        embed.add_field(
                            name="<:1000182584:1396049547838492672> ¬øQu√© pasar√° ahora?",
                            value="‚Ä¢ El bot reaccionar√° autom√°ticamente a **todos** los mensajes nuevos en este canal\n‚Ä¢ Se usar√° el emoji <a:clown:1418508263984463932>\n‚Ä¢ Solo afecta a mensajes enviados despu√©s de la activaci√≥n",
                            inline=False
                        )
                    else:
                        embed = discord.Embed(
                            title="‚ùå Error de Activaci√≥n",
                            description="No se pudo activar las reacciones autom√°ticas.",
                            color=0xff0000
                        )

            elif accion.lower() == "off":
                if not current_status:
                    embed = discord.Embed(
                        title="‚èπÔ∏è Ya Desactivado",
                        description="Las reacciones autom√°ticas con emoji clown ya est√°n **desactivadas** en este canal.",
                        color=0x6c757d
                    )
                else:
                    success = clown_manager.deactivate_channel(channel_id)
                    if success:
                        embed = discord.Embed(
                            title="‚èπÔ∏è Reacciones Desactivadas",
                            description="Las reacciones autom√°ticas con emoji clown han sido **desactivadas** en este canal.",
                            color=0xff9900
                        )
                        embed.add_field(
                            name="<:1000182584:1396049547838492672> Estado:",
                            value="‚Ä¢ El bot ya no reaccionar√° autom√°ticamente a mensajes nuevos\n‚Ä¢ Las reacciones existentes no se eliminan\n‚Ä¢ Puedes reactivar usando `/clown on`",
                            inline=False
                        )
                    else:
                        embed = discord.Embed(
                            title="‚ùå Error de Desactivaci√≥n",
                            description="No se pudo desactivar las reacciones autom√°ticas.",
                            color=0xff0000
                        )

            elif accion.lower() == "toggle":
                if current_status:
                    # Desactivar
                    success = clown_manager.deactivate_channel(channel_id)
                    if success:
                        embed = discord.Embed(
                            title="‚èπÔ∏è Reacciones Desactivadas",
                            description="Las reacciones autom√°ticas con emoji clown han sido **desactivadas** en este canal.",
                            color=0xff9900
                        )
                    else:
                        embed = discord.Embed(
                            title="‚ùå Error",
                            description="No se pudo cambiar el estado de las reacciones.",
                            color=0xff0000
                        )
                else:
                    # Activar
                    success = clown_manager.activate_channel(channel_id)
                    if success:
                        embed = discord.Embed(
                            title="<a:clown:1418508263984463932> Reacciones Activadas",
                            description="¬°Las reacciones autom√°ticas con emoji clown han sido **activadas** en este canal!",
                            color=0x00ff88
                        )
                        embed.add_field(
                            name="<:1000182584:1396049547838492672> ¬øQu√© pasar√° ahora?",
                            value="‚Ä¢ El bot reaccionar√° autom√°ticamente a **todos** los mensajes nuevos\n‚Ä¢ Se usar√° el emoji <a:clown:1418508263984463932>\n‚Ä¢ Solo afecta a mensajes enviados despu√©s de la activaci√≥n",
                            inline=False
                        )
                    else:
                        embed = discord.Embed(
                            title="‚ùå Error",
                            description="No se pudo cambiar el estado de las reacciones.",
                            color=0xff0000
                        )

            elif accion.lower() == "status":
                # Mostrar estado actual
                status_text = "<a:clown:1418508263984463932> **Activado**" if current_status else "‚èπÔ∏è **Desactivado**"
                embed = discord.Embed(
                    title="<:1000182584:1396049547838492672> Estado de Reacciones Clown",
                    description=f"Estado actual en este canal: {status_text}",
                    color=0x00ff88 if current_status else 0x6c757d
                )
                
                embed.add_field(
                    name="<:1000182750:1396420537227411587> Canal Actual:",
                    value=f"{interaction.channel.mention}\n`{interaction.channel.name}`",
                    inline=True
                )
                
                embed.add_field(
                    name="<:stats:1418490788437823599> Canales Activos Globalmente:",
                    value=f"`{clown_manager.get_active_channels_count()}`",
                    inline=True
                )
                
                embed.add_field(
                    name="<:1000182751:1396420551798558781> Comandos Disponibles:",
                    value="‚Ä¢ `/clown on` - Activar reacciones\n‚Ä¢ `/clown off` - Desactivar reacciones\n‚Ä¢ `/clown toggle` - Alternar estado\n‚Ä¢ `/clown status` - Ver este estado",
                    inline=False
                )

            else:
                embed = discord.Embed(
                    title="‚ùå Acci√≥n Inv√°lida",
                    description="Acci√≥n no reconocida. Usa: `on`, `off`, `toggle`, o `status`",
                    color=0xff0000
                )

            # Agregar informaci√≥n del canal y usuario
            embed.add_field(
                name="<:1000182750:1396420537227411587> Canal:",
                value=f"{interaction.channel.mention}",
                inline=True
            )
            
            embed.add_field(
                name="<:1000182644:1396049313481625611> Ejecutado por:",
                value=f"{username}",
                inline=True
            )
            
            embed.add_field(
                name="<:1000182657:1396060091366637669> Hora:",
                value=f"<t:{int(datetime.now().timestamp())}:T>",
                inline=True
            )

            embed.set_footer(text="RbxServers ‚Ä¢ Sistema de Reacciones Autom√°ticas")

            await interaction.followup.send(embed=embed, ephemeral=True)
            logger.info(f"Owner {username} ejecut√≥ /clown {accion} en canal {channel_id}")

        except Exception as e:
            logger.error(f"Error en comando /clown: {e}")
            embed = discord.Embed(
                title="‚ùå Error Interno",
                description="Ocurri√≥ un error al procesar el comando de reacciones clown.",
                color=0xff0000
            )
            embed.add_field(name="üêõ Error", value=f"```{str(e)[:150]}```", inline=False)
            await interaction.followup.send(embed=embed, ephemeral=True)

    # Evento para reaccionar autom√°ticamente a mensajes
    @bot.event
    async def on_message(message):
        """Evento para reaccionar autom√°ticamente con emoji clown"""
        try:
            # Ignorar mensajes del bot
            if message.author.bot:
                return

            # Ignorar mensajes en DM
            if not message.guild:
                return

            channel_id = str(message.channel.id)
            
            # Verificar si el canal tiene reacciones autom√°ticas activadas
            if not clown_manager.is_channel_active(channel_id):
                return

            # Verificar permisos del bot
            permissions = message.channel.permissions_for(message.guild.me)
            if not permissions.add_reactions:
                logger.warning(f"‚ö†Ô∏è Sin permisos para reaccionar en canal {channel_id}")
                return

            # Intentar reaccionar con el emoji clown
            try:
                # Emoji personalizado animado clown
                clown_emoji = "<a:clown:1418508263984463932>"
                await message.add_reaction(clown_emoji)
                
                logger.debug(f"<a:clown:1418508263984463932> Reacci√≥n autom√°tica a√±adida al mensaje {message.id} en canal {channel_id}")
                
            except discord.NotFound:
                logger.warning(f"‚ö†Ô∏è Mensaje {message.id} no encontrado para reaccionar")
            except discord.Forbidden:
                logger.warning(f"‚ö†Ô∏è Sin permisos para reaccionar al mensaje {message.id} en canal {channel_id}")
                # Desactivar autom√°ticamente el canal si no hay permisos
                clown_manager.deactivate_channel(channel_id)
                logger.info(f"‚èπÔ∏è Canal {channel_id} desactivado autom√°ticamente por falta de permisos")
            except discord.HTTPException as e:
                if "Unknown Emoji" in str(e):
                    logger.error(f"‚ùå Emoji clown no disponible en servidor del canal {channel_id}")
                    # Desactivar el canal si el emoji no est√° disponible
                    clown_manager.deactivate_channel(channel_id)
                    logger.info(f"‚èπÔ∏è Canal {channel_id} desactivado autom√°ticamente por emoji no disponible")
                else:
                    logger.error(f"‚ùå Error HTTP reaccionando en canal {channel_id}: {e}")
            except Exception as reaction_error:
                logger.error(f"‚ùå Error inesperado reaccionando en canal {channel_id}: {reaction_error}")

        except Exception as e:
            logger.error(f"‚ùå Error cr√≠tico en evento on_message para reacciones clown: {e}")

    logger.info("<a:clown:1418508263984463932> Sistema de reacciones autom√°ticas clown configurado exitosamente")
    return True

def cleanup_commands(bot):
    """Funci√≥n de limpieza opcional"""
    pass
